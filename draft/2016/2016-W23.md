# goal

- [ ] 『計算機プログラムの構造と解釈 (SICP) 』を読む (2章)
- [x] [bouzuya/eater-b-reporter][] のことを書く
- [x] Qiita に [yosuke-furukawa/eater][] の reporter のことを書く
- [x] [bouzuya/beater][] のことを書く
- [x] [bouzuya/beater][] をつくる

# diary

- 2016-06-12 Sun 朝X。英語X。読書X。たまった blog を書く。beater まだ着手せず。ハンターハンター 33 。
- 2016-06-11 Sat 朝X。英語X。読書X。『フロントエンドの人がWeb APIを語る会』再々設計。file という単位を検討しなおす。意見を聞くが悩む。
- 2016-06-10 Fri 朝X。英語X。読書X。browser support を実装完了。 browserify / webpack を調査したら死んだ。
- 2016-06-09 Thu 朝X。英語X。読書X。kyoto.js で相談→ browser support を決意。 browser support で再設計。実装。
- 2016-06-08 Wed 朝O。英語X。読書X。風邪。
- 2016-06-07 Tue 朝X。英語X。読書X。たまった blog 。
- 2016-06-06 Mon 朝X。英語X。読書X。beater の test を追加。

# blog

- 2016-06-12 Sun 今週のふりかえり
- 2016-06-11 Sat kfug のフロントエンドの人がWeb APIを語る会に参加した
- 2016-06-10 Fri beater の browser support に失敗した
- 2016-06-09 Thu beater の browser support をかんがえた
- 2016-06-08 Wed beater をつくった
- 2016-06-07 Tue eater-b-reporter 作成時に踏んだバグ
- 2016-06-06 Mon eater-b-reporter をつくった

## 2016-06-11 Sat

kfug の[フロントエンドの人がWeb APIを語る会](http://kfug.connpass.com/event/32138/) に参加した。

今回は [@_likr](https://twitter.com/_likr) の意見から決まったらしい、もはや front-end なのかも分からない Web API がお題。登壇者が時間に全然来ていない問題はありつつも楽しい会だった。

個人的な興味は GraphQL / Falcor の話。ぼくのいまの感覚を表現しているのは次の tweet 。

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">client-side で RDBMS は意味がないかもしれないけど、似たような効率よくキャッシュするための層は設けられそうだよな……。</p>&mdash; bouzuya (@bouzuya) <a href="https://twitter.com/bouzuya/status/741522612182867970">2016年6月11日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">graphql は client-side だけじゃ対応できないから導入が難しいんじゃないかと思ってる。client / server のまたがるところに対してのソリューションなので影響範囲が大きくなってしまう。<a href="https://twitter.com/hashtag/frontkansai?src=hash">#frontkansai</a></p>&mdash; bouzuya (@bouzuya) <a href="https://twitter.com/bouzuya/status/741545895406108673">2016年6月11日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

Falcor のような cache 層は将来的には常識になりそう。GraphQL のような QL は導入こそ難しいものの、特化した view を提供するのが大変なのは事実で、使われるようになる可能性は十分ありそう。REST よりよっぽど便利だろうしね。

ちなみに終始 [bouzuya/beater][] の api のことを考えていた。

## 2016-06-10 Fri

[2016-06-09][] の続き。[bouzuya/beater][] の browser support を検証した。想定通りにいかず、大幅な見直しが必要になった。

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">beater の browser 対応、できてなかった</p>&mdash; bouzuya (@bouzuya) <a href="https://twitter.com/bouzuya/status/741053851139072000">2016年6月9日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

[substack/node-browserify][] / [webpack/webpack][] でいろいろ試したが難しそうな状況だ。beater では `test/*.js` 相当の file 群を動的に `require()` するつもりだったが簡単にはいかない。

まず browserify 。

browserify は `require()` の中身が変数の場合は `bundle.js` に含めてくれない。類似の issue は [substack/node-browserify#377](https://github.com/substack/node-browserify/issues/377) にある。`bundle.js` に含まれない点だけであれば [substack/bulkify][] を使えば解決できる。bulkify は glob で `bundle.js` に含めることはできるが、読み込む時点の制御はできない。

module ごとに `require()` で読み込まれる module を変更することも意外と難しい。なので file (module name) を渡して、それを `require()` するのは意外と難しい。独自の browserify transform を用意すれば理論上できそうだけど、利用側での問題が増えそうだ。

次に webpack 。

webpack は browserify の箇所で紹介した issue にもあるが context という考え方を持つ。これは `require(expr)` / `require('pre-' + expr)` などの形に応じて directory をわりと乱暴に読み込むものだ。現状の問題としては余計なものを読み込みすぎて死ぬ。`'fs'` や `'child_process'` に依存するものを読み込んでしまう。無理にでもこれを修正してみたが、今度は `require()` の relative path の指定が思ったようにできず、苦しむ。つくったぼくでこれだ。beater の挙動を知らないと、なぜそんな設定をするのか、どのような path が正解なのか分からないはずだ。

上記に一日費やして、ぼくはひとつ結論に至った。browser で動的な `require()` を前提にするのは避けるべきだ。ES Modules の観点でも静的解析できるほうが望ましい。

では ES Modules を前提にするとどうなるのか。いまの `test()` を読み込む時点で実行する構造をとったときは entry point を各 file に置く必要が出てくる。files などの指定ではなくなってしまう。いま考えているのは `test()` を `Test` の定義として使い、実行の意味を奪う案だ。 `const t1 = test(...); export default t1;` して `Test` を export してもらう module をつくれば良い気がしている。考え方は大きく変わるが production code と同じ気持ちで test を書くことができるように思う。

もうすこし考える。

## 2016-06-09 Thu

[bouzuya/beater][] の browser support を検討した。

slack kyoto.js team で beater の意見を聞いたところ browser support の話が出た。

その場でのぼくの気持ちは「やっぱり難しそう……。いや、動かすだけならできそうだけど、何を大切にしたいのかを見失いそう。」という発言に落ち着いた。

「 browser でも動く」という位置は mocha を目指すと避けられない。個人的には十分な beater なのだけど、目標は post mocha, 50 stars。再設計して browser support を目指すことにした。

このあたりの流れは、次の tweet からの一連の tweet で検討している。

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">beater をブラウザに載せる想定で、再設計しよう。</p>&mdash; bouzuya (@bouzuya) <a href="https://twitter.com/bouzuya/status/740834105194123264">2016年6月9日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">`Beater` class の API は Browser でも動くように考慮したものに変えよう。エントリーポイントはユーザーに作成してもらって require はなんとかして提供してもらおう。</p>&mdash; bouzuya (@bouzuya) <a href="https://twitter.com/bouzuya/status/740866293834776577">2016年6月9日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

beater の設計を大きく次のように見直した。

- `test()` 必須なので file 単位の隔離は重要でない。
  - browser を制御して file 分離しなくても良い。browser を制御しない。
  - `window` (`global`) を共有しても良い。共有する。
  - mocha のように browser 内で動くようにする。
- `test()` と `reporter` をつなぐべき。
- `--dir` / `--ext` など browser で使えないので `Beater` class から消す。
- mocha / tape / jasmine などで十分に思えるが、そこに新たな選択肢を加える。
- 動的に `require()` して `test()` を呼ばせて実行する。
- server-side は files から走査して実行する。
- client-side は `Beater` に `Test` を渡して実行する。
- それぞれに適した Runner を `process.browser` で選択する。

で、[bouzuya/beater][] に browser support を軽く実装した。実際に試していない。理屈の上では動く。

- beater の doc/ の追加
- Runner interface の追加
- ServerRunner / ClientRunner の追加
- その他 directory の整理

検証は進めていく。

## 2016-06-08 Wed

[bouzuya/beater][] をつくった。bouzuya's eater で beater 。bouzuya 版 [yosuke-furukawa/eater][] だ。eater のことは [2016-06-04][] に書いた。

[bouzuya/beater][] は eater からぼくの欲しい部分を抜き出したものだ。

eater と比較すると次のような特徴がある。

- eater と同じく、file ごとに child process を割り当てる。
  - eater と同じく、browser を想定しない。
- eater と同じく、`describe` / `it` など global を汚す関数を提供しない。
- eater と同じく、`assert` を提供しない。
- eater と同じく、`--watch` を提供しない。
- eater と同じく、非同期を前提とする。
  - eater と異なり、 `done()` `fail()` を提供しない。
    - `Promise` を返すと待つようにした。
    - 毎回 `done()` を呼ばなくて済む。
- eater と異なり、stderr -> Error に変更した。
  - eater の simple rule を破棄した。
  - file ごとの出力を reporter が制御できる。
- eater と異なり、`test()` の使用を前提とした。
  - eater の example を動かす想定を破棄した。
    - `test()` を使う人にとっての Easy を想定する。
  - eater の mock の開放不要を破棄した。
    - `test()` 単位に context の生成・破棄が必要になるため。
      - ? この点 eater は `test()` を提供しているがどうなんだろう……。
      - https://twitter.com/yosuke_furukawa/status/740535860722958336
      - https://twitter.com/yosuke_furukawa/status/740538626337996800
      - https://twitter.com/yosuke_furukawa/status/740541754365992962
  - `before` / `after` のための `fixture()` を提供する。
- eater と異なり、TypeScript を想定し、`.d.ts` を提供する。

eater の観点を捨てて、乱暴に説明するなら [avajs/ava][] の機能縮小版だ。

実際の test は次のような雰囲気だ。

```js
import * as assert from 'power-assert';
import { test, fixture } from 'beater';

test('simple test', () => {
  assert(1 === 1);
});

test('async test', () => {
  return new Promise(resolve => {
    assert(2 === 2);
    resolve();
  });
});

const before = () => 3; // setup fixture (context)
const after = context => void 0;// clean up fixture (context)
test('before/after', fixture({ before, after }, context => {
  assert(context === 3);
}));
```

まだ絶賛開発中なので `(beta)` をつけているが、ぼくの Node.js 環境における標準の test framework/runner にしたいと考えている。

ぜひ [bouzuya/beater][] を試してみて、意見をほしい。意見がなくても star がほしい、それはもう真剣に。

## 2016-06-07 Tue

[2016-06-06][] に書いた [bouzuya/eater-b-reporter][] 。それをつくった際に踏んだ Node.js の bug ([nodejs/node#6773][]) について書く。

これは `process.exit()` された際に stdour/stderr が flush されない問題だ。eater-b-reporter では Error を表示した際に最後まで出力されることなく process が終了される形で起きた。

[yosuke-furukawa/eater][] は Error がある場合に exit code 1 で終了させる。そのために `process.exit(1)` を呼び出す。この `process.exit(1)` が上記の bug により stdout/stderr に残った buffer を無視して終了させる。

現状、あまり良さそうな対策はない。上記 pull request にも挙がっている stdout/stderr を blocking する案 ([nodejs/node#6456][]) を採ると、とりあえずは直せる。その特性からして効率は悪くなるだろうけど……。

[bouzuya/eater-b-reporter][] は [nodejs/node#6456][] を npm package 化した [yargs/set-blocking](https://github.com/yargs/set-blocking) を使っている。Node.js の version が上がって直ってくれれば削除する予定だ。

[nodejs/node#6456]: https://github.com/nodejs/node/issues/6456
[nodejs/node#6773]: https://github.com/nodejs/node/pull/6773

## 2016-06-06 Mon

[bouzuya/eater-b-reporter][] をつくった。

[bouzuya/eater-b-reporter][] は [yosuke-furukawa/eater][] の reporter だ。

[bouzuya/eater-b-reporter][] の目的は eater の reporter の弱さを補うものだ。これは [2016-06-01][] にも書いた。 [bouzuya/rfc6570-expand][] の test に [yosuke-furukawa/eater][] を使用した際に感じた eater の reporter の問題点を解決する。

ぼくが eater の標準の reporter ([Reporter](https://github.com/yosuke-furukawa/eater/blob/v1.7.0/lib/reporter/Reporter.js)) で気になる点は 3 つある。

1. Error の表示が流れてしまう。
2. Error の表示順序がばらばらだ。
3. 成功・失敗の件数が分からない。

Error が流れてしまうため、赤い文字に気づいたら scroll して確認しないといけない。極めて面倒だ。test の件数が増えると致命的になる。ご丁寧にすべての file 内の test 別に成否を問わずに出力するため、相当量が流れる。

Error の表示順序がばらばらというのは、複数の file の Error が入り乱れる状態だ。file が child process だから file 順にならない……という程度ならまだいい。eater の reporter は複数の file の Error が入り乱れる。failure の行とその次の行の stack trace が同じ file の Error かさえ分からない。ひどい。

成功・失敗の件数が分からない。これは [TapReporter](https://github.com/yosuke-furukawa/eater/blob/v1.7.0/lib/reporter/TapReporter.js) なら良いのだけど (こちらはこちらで……) 、標準の Reporter だと表示されない。どれくらい成功しているのかがつかめないので、あと何件直すのか分からない。先の Error が流れる問題もあって、どこまで scroll すればいいのか分からない状態になる。それも実行するたびだ。

その解決策が [bouzuya/eater-b-reporter][] だ。

次の例は成功時の出力だ。

```
npm test


> rfc6570-expand@0.1.0 test /home/ubuntu/rfc6570-expand
> beater

19 files
✓ success: .tmp/test/index.js
✓ success: .tmp/test/extended2.js
✓ success: .tmp/test/extended1.js
✓ success: .tmp/test/section3-2-1.js
✓ success: .tmp/test/extended3.js
✓ success: .tmp/test/section3-2-6.js
✓ success: .tmp/test/section3-2-5.js
✓ success: .tmp/test/section3-2-8.js
✓ success: .tmp/test/section3-2-7.js
✓ success: .tmp/test/level2.js
✓ success: .tmp/test/level1.js
✓ success: .tmp/test/extended4.js
✓ success: .tmp/test/negative.js
✓ success: .tmp/test/level3.js
✓ success: .tmp/test/section3-2-9.js
✓ success: .tmp/test/section3-2-3.js
✓ success: .tmp/test/level4.js
✓ success: .tmp/test/section3-2-2.js
✓ success: .tmp/test/section3-2-4.js
✓ 19 files 234 tests completed
```

最初にすべての file 数を表示する。成功した file は名前のみを表示する。最後に file 数と test 数を表示する。成功した file については `test()` 単位では表示しないため簡素になる。また最後の行で file 数や test 数が表示されるので、きちんと完了したことが分かる。

次の例は失敗時の出力だ。

```
19 files
✓ success: .tmp/test/extended3.js
✓ success: .tmp/test/extended1.js
✓ success: .tmp/test/extended2.js
✓ success: .tmp/test/extended4.js
✓ success: .tmp/test/index.js
✓ success: .tmp/test/level2.js
✓ success: .tmp/test/level4.js
✓ success: .tmp/test/negative.js
✓ success: .tmp/test/section3-2-1.js
✓ success: .tmp/test/section3-2-3.js
✓ success: .tmp/test/section3-2-4.js
✓ success: .tmp/test/section3-2-5.js
✓ success: .tmp/test/section3-2-6.js
✓ success: .tmp/test/section3-2-7.js
✓ success: .tmp/test/section3-2-8.js
✓ success: .tmp/test/section3-2-9.js
✗ failure: .tmp/test/level1.js
AssertionError: {hello} / Hello%20World%21 / Hello%20World%s21   # .tmp/test/level1.js:12

  assert(uris.some(u => u === uri), `${ template } / ${ uris } / ${ uri }`)
         |    |                                                            
         |    false                                                        
         ["Hello%20World%21"]                                              

    at Decorator._callFunc (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:110:20)
    at Decorator.concreteAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:103:17)
    at decoratedAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorate.js:49:30)
    at powerAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/index.js:63:32)
    at runner_1.test.resolve (.tmp/test/level1.js:12:9)
    at EventEmitter.nextTest (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:22:26)
    at emitNone (events.js:86:13)
    at EventEmitter.emit (events.js:185:7)
    at checkPromise.then (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:26:18)
    at process._tickCallback (internal/process/next_tick.js:103:7)

✗ failure: .tmp/test/level3.js
AssertionError: {x,hello,y} / 1024,Hello%20World%21,768 / 1024,Hello%20World%s21,768   # .tmp/test/level3.js:12

  assert(uris.some(u => u === uri), `${ template } / ${ uris } / ${ uri }`)
         |    |                                                            
         |    false                                                        
         ["1024,Hello%20World%21,768"]                                     

    at Decorator._callFunc (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:110:20)
    at Decorator.concreteAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:103:17)
    at decoratedAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorate.js:49:30)
    at powerAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/index.js:63:32)
    at runner_1.test.resolve (.tmp/test/level3.js:12:9)
    at EventEmitter.nextTest (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:22:26)
    at emitNone (events.js:86:13)
    at EventEmitter.emit (events.js:185:7)
    at checkPromise.then (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:26:18)
    at process._tickCallback (internal/process/next_tick.js:103:7)

✗ failure: .tmp/test/section3-2-2.js
AssertionError: {hello} / Hello%20World%21 / Hello%20World%s21   # .tmp/test/section3-2-2.js:14

  assert(uris.some(u => u === uri), `${ template } / ${ uris } / ${ uri }`)
         |    |                                                            
         |    false                                                        
         ["Hello%20World%21"]                                              

    at Decorator._callFunc (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:110:20)
    at Decorator.concreteAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:103:17)
    at decoratedAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorate.js:49:30)
    at powerAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/index.js:63:32)
    at runner_1.test.resolve (.tmp/test/section3-2-2.js:14:9)
    at EventEmitter.nextTest (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:22:26)
    at emitNone (events.js:86:13)
    at EventEmitter.emit (events.js:185:7)
    at checkPromise.then (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:26:18)
    at process._tickCallback (internal/process/next_tick.js:103:7)
AssertionError: {x,hello,y} / 1024,Hello%20World%21,768 / 1024,Hello%20World%s21,768   # .tmp/test/section3-2-2.js:14

  assert(uris.some(u => u === uri), `${ template } / ${ uris } / ${ uri }`)
         |    |                                                            
         |    false                                                        
         ["1024,Hello%20World%21,768"]                                     

    at Decorator._callFunc (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:110:20)
    at Decorator.concreteAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorator.js:103:17)
    at decoratedAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/lib/decorate.js:49:30)
    at powerAssert (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/empower-core/index.js:63:32)
    at runner_1.test.resolve (.tmp/test/section3-2-2.js:14:9)
    at EventEmitter.nextTest (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:22:26)
    at emitNone (events.js:86:13)
    at EventEmitter.emit (events.js:185:7)
    at checkPromise.then (/Users/bouzuya/.ghq/github.com/bouzuya/rfc6570-expand/node_modules/eater/lib/runner.js:26:18)
    at process._tickCallback (internal/process/next_tick.js:103:7)

✗ 3 of 19 files, 4 of 234 tests failed
npm ERR! Test failed.  See above for more details.
```

reporter とは関係ないが Error 表示は [power-assert-js/power-assert][] を使っていることもあって詳細だ。

Error は最後に集中して表示する。流さない。Error の表示順序はファイルごとに並んでいる。最後に全体のうちいくつの file, test が失敗したのかを表示している。安心感がある。

さきに挙げた 3 つの問題を解決していることが分かる。

1. Error の表示が流れてしまう。
2. Error の表示順序がばらばらだ。
3. 成功・失敗の件数が分からない。

[bouzuya/eater-b-reporter][] の実装は例によって TypeScript だ。eater は JavaScript なので、型は自分で用意した。

reporter の API に関しては Qiita に記事を書いたので、そちらを参照すると良い。 link は [eater の reporter の API - Qiita](http://qiita.com/bouzuya/items/3abfb65a9d3b26bf65a4) だ。

つくる過程で Node.js の bug を踏んだのだけど、これについてはまた日を改める。

[bouzuya/eater-b-reporter][] の実例を見たいなら [bouzuya/rfc6570-expand][] で試してみるといい。

```
$ git clone https://github.com/bouzuya/rfc6570-expand
$ cd rfc6570-expand/
$ npm i
$ npm test
```

適当に test が通らないようにすれば失敗例も確認できる。
