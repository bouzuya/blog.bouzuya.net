# goal

- [ ] 『計算機プログラムの構造と解釈 (SICP) 』を読む (2章)
- [x] [yosuke-furukawa/eater][] のことを書く
- [x] [RFC 6570 URI Template](https://tools.ietf.org/html/rfc6570) の実装のことを書く
- [x] 今月のふりかえりを書く
- [x] ソロモンの偽証の件
- [x] Eater の件

# diary

- 2016-06-05 Sun 朝X。英語X。読書X。eater-b-reporter で Node.js の bug をふんだ。beater をつくった。
- 2016-06-04 Sat 朝X。英語X。読書X。bbn や rfc-npm-packages を修正した。 yosuke-furukawa/eater の reporter をつくった。
- 2016-06-03 Fri 朝X。英語X。読書X。RFC 6570 全 spec 対応。
- 2016-06-02 Thu 朝O。英語X。読書X。blog を書いた。
- 2016-06-01 Wed 朝X。英語X。読書X。RFC 6570 level 4 対応。
- 2016-05-31 Tue 朝X。英語X。読書X。誕生日会。
- 2016-05-30 Mon 朝X。英語X。読書X。『ズートピア』を観た。

# blog

- 2016-06-05 Sun 今週のふりかえり
- 2016-06-04 Sat yosuke-furukawa/eater の reporter をつくった
- 2016-06-03 Fri bouzuya/rfc6570-expand をつくった && テスト駆動を実感した
- 2016-06-02 Thu 『ソロモンの偽証』をみた
- 2016-06-01 Wed RFC 6570 level 4 対応
- 2016-05-31 Tue 今月のふりかえり
- 2016-05-30 Mon 『ズートピア』をみた

## 2016-06-04 Sat

[yosuke-furukawa/eater][] を試した。

[yosuke-furukawa/eater][] は EAsy Test runnER の名前のとおり、簡単に使える test runner だ。

"test runner" という区分がいまひとつ分からない。動きから見ると eater は file ごとに child process を動かす。file 内の `test()` で assert を group 化し、その単位で実行結果を report してくれる。動作は Node.js を想定し web browser を想定していない。そして assert の機能を持っていない。

"test runner" と言うと [karma-runner/karma][] や [testem/testem][] ([2014-04-16][]) を想像する。karma や testem は headless browser を含めて制御する。mocha や jasmine のような test framework で書かれた test を browser で動かすから test runner だ。 headless browser の制御という意味なら [casperjs/casperjs][] も近いかもしれない。CasperJS [ariya/phantomjs][] や [laurentj/slimerjs][] の wrapper のような感覚だけど……。

脱線した。 eater を test runner として見るなら Node.js 限定の test runner だ。 child_process などを使っているので、おそらく web browser 動かないだろう (試したわけではない) 。

さて test framework (mocha/AVA) との違いを見る。

まず、ぼくの test framework 歴は次のような流れだ。

[mochajs/mocha][] -> [avajs/ava][] -> [yosuke-furukawa/eater][]

AngularJS 時代に Jasmine を使っていた気もするけど、blog に記述がないので気のせいということにする。そして上記の test runner かという点には触れないでおく。

eater はここ数日の間につくった [bouzuya/rfc6570-expand][] で軽く試した。また source code をひととおり読んだ。次の記事はここ数日のものだ。

- [2016-06-01][] bouzuya/rfc6570-expand を RFC 6570 URI Template level 4 に仮対応させた
- [2016-06-03][] bouzuya/rfc6570-expand をつくった && TDD の良さを再認識した

上記の経験を踏まえて書く。あくまで軽く試した上での比較・感想だ。

[mochajs/mocha][] には assert の機能を持っていない点で似ている。describe /it で global を汚染する点は大きな欠点だ。 eater は `test()` に閉じているのでこの点は問題ない。mocha は `before()` との context 共有に `this` を使う点が `() => {}` にあっていない。 eater にはそもそも `before()` がない。mocha は test の定義と実行を切り離している印象を受ける (実装がどうかは知らない) が、eater の test は区別なく実行している印象を受ける。mocha の `it` の callback に `done(error?: Error)` を指定すると非同期になる謎挙動だ。eater は `new Promise(f)` の `f` を流用しているため `(resolve, reject) => {}` だ。引数の明快さはともかく、毎回 `resolve` を呼ばされるのは eater の良くない点だ。mocha は web browser で動くが、eater は動かない。良くない。

[avajs/ava][] には child process を使って高速化する点や describe / it で global を汚染しない点、web browser で動かない点で似ている。非同期への support の手厚さが違う。AVA は戻り値で `Promise` / `Generator` / `async` / `Observable` などを取れる。eater はどれも対応していない。`resolve` を呼べ。それだけだ。AVA はやりすぎだ。eater もまたやりすぎている気はする。AVA は後述するが、これに起因する問題がある。

ざっと書いた。漏れ等ありそうだけど、とりあえず思いつくままに書いた。

ぼくの AVA -> eater の理由を書く。

[2016-03-11][] にぼくは [AVA][avajs/ava] のことを書いた。[mochajs/mocha][] から [avajs/ava][] への乗り換えを検討していたからだ。これは上位互換ではない。mocha は web browser で動くが AVA は web browser で動かない。そこは妥協した。web browser の互換性の test をしたいわけではないからだ。AVA はそこを抜きにすればそこそこ期待通りに動く。しかし、AVA には大きな問題がある……大きいことだ。

AVA は大きい。power-assert や babel を含んでいる。これは将来を見越している。Promise / Generator / async / Observable 。これらに対応するため、いろいろなものを含んでいる。だから巨大だ。環境構築の手間は省けるのだけど、複雑で巨大すぎた。 Observable support が壊れたり ([2016-03-25][]) 、.d.ts まで手が回らなかったり ([2016-03-26][]) した。不安を感じた。

そこで [eater][yosuke-furukawa/eater] だ。

eater は小さい。eater は easy というより simple だ。assert を持たない。before / after も Promise support さえ持たない。それにそこまでの不満は感じないし、何より小さい。source code を読んでから使いはじめられる。source code は数えるほどしかない。機能は少ない。しかし、小さいので不安も小さい。

eater の示した方向に大きな不満はない。mocha のように `assert` を捨てており小さいが、 mocha のように describe / it で global を汚染したり、`--watch` を持ち込んだりしない。それでも小さな不満はある。

たとえば reporter が弱い。見づらい。Error は流れてしまうし、非同期処理のせいか、success と failure が混ざる。件数も分からない。件数が分かる reporter を使うと詳細が一切表示されない。せっかくなので自作してみることにした。

[bouzuya/eater-b-reporter][] ([npm:eater-b-reporter][]) だ。

もともとこの reporter について書こうと思ったが、長くなってしまったので日を改める。

[npm:eater-b-reporter]: https://www.npmjs.com/package/eater-b-reporter

## 2016-06-03 Fri

[bouzuya/rfc6570-expand][] 0.1.0 を npm に公開した。

[bouzuya/rfc6570-expand][] は [RFC 6570 URI Template](https://tools.ietf.org/html/rfc6570) の展開を実装したもの。`npm install rfc6570-expand` で利用できる。詳細は [bouzuya/rfc6570-expand][] を参照してほしい。ちなみに以前 [2016-06-01][] で実装の進捗を報告している。

目的は [yosuke-furukawa/eater][] の簡単な検証と [uri-templates/uritemplate-test][] を pass する実装の提供。実装を活用する意図はないので、軽い運動のようなもの。

実装については [2016-06-01][] を参照してほしい。[2016-06-01][] からの差分としては、仕様通りに実装したとは言わないが、ひとまず [uri-templates/uritemplate-test][] の spec はすべて通るようになっている。[RFC 3986](https://tools.ietf.org/html/rfc3986) ではなく [URL Standard](https://url.spec.whatwg.org/) に変更する option は未実装。 [RFC 6570](https://tools.ietf.org/html/rfc6570) についても前述のとおり仕様通りとは断言できない状況。

今回の経験は TDD : Test-Driven Development の良さの再認識だ。まず TDD / Test-first が常に良い・正しいとは思わない。しかし今回はその良さを改めて感じた。また「 TDD は設計だ」と主張する人にとっては主語が大きすぎるかもしれない。言い直すなら「テストにより開発を進めたくなった」あるいは「テスト駆動を実感した」あたりだろうか。

今回は [uri-templates/uritemplate-test][] により test がすべて提供されていた。Test-first を自然に実現できていた。あとはこれを pass するように実装していくだけだ。既にある test を pass するように実装するのは楽しい。ちょうど game の quest や mission のようなもので明確な目標を達成する状態だ。目標がはっきりしていたおかげで投げ出さなかった。これが「テスト駆動を実感した」と書いた意味だ。

また [4Clojure](http://www.4clojure.com/) をはじめとする Koan も今回の Test-Driven な要素を持つように感じる。Koan (公案) は次のように説明されている。

[こうあん【公案】の意味 - goo国語辞書](http://dictionary.goo.ne.jp/jn/71651/meaning/m0u/)

> １ 官庁の文書。公文書。
> ２ 禅宗で、参禅者に考える対象や手がかりにさせるために示す、祖師の言葉・行動。
> ３ 工夫。

[公案 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%85%AC%E6%A1%88)

> 1. 中国で、古代から近世までの役所が発行した文書。調書・裁判記録・判例など。
> 2. 上記の意味から派生して、禅宗において修行者が悟りを開くための課題として与えられる問題のこと。

[Rx で Koan した - steps to phantasien](http://steps.dodgson.org/b/2014/10/01/playing-with-rx-koans/)

> Koans を解くのはちょっと楽しい。Rx に限らず入門目的のちょっとしたコーディング問題集を Koan とよぶのはある種のならわしらしい。Code Koans などを検索すると色々みつかる。語源はたぶん「公案」なのだろう。本来の意味とは外れている気もするけれど気にしないでおこう。Koan だの Kata だのの Zen terminology を好む Kamikaze Ninjas はなぜか一定数いるからね。

Programming での Koan は初学者向けの問題集だ。ぼくの知る範囲では Test code が用意されており、それを pass するように書き換えるものが多い。これはぼくが今回経験した Test-Driven な要素に近い。

前述のとおり、ぼくは以前 4Clojure で遊んでいた。

- [2012-04-24][] 4Clojure を楽しむ (1)
- [2012-04-25][] 4Clojure を楽しむ (2)
- [2012-05-06][] 4Clojure を楽しむ (3)
- [2012-05-07][] 4Clojure を楽しむ (4)
- [2012-05-08][] 4Clojure を楽しむ (5)
- [2012-05-09][] 4Clojure を楽しむ (6)
- [2012-05-16][] 4Clojure を楽しむ (7)
- [2012-05-21][] 4Clojure を楽しむ (8)
- [2012-05-22][] 4Clojure を楽しむ (9)
- [2012-05-27][] 4Clojure を楽しむ (10)
- [2013-01-10][] ひさびさに 4clojure

[2012-05-06][] には次のようにある。

> やる気を高める仕組みも良い。問題を解くのはゴールが明らかで、あと何問を解こうといった風にやる気が高まる。問題を解くとグリーンのチェックが付くし、ユーザーページのグラフも進む。達成感が得られる。

4Clojure はほかにもいろいろな工夫を含むのだけど、 Test-Driven な要素があるのは確かだ。

脱線して TDD / Koan のことを書いてしまったのだけど、Test-first にするとそれに引っ張られて開発が進む、Test-Driven な要素はあるということが言いたかった。

[bouzuya/rfc6570-expand][] に戻って残りの課題だけど、可能なら先にも書いた URL Standard 対応や、仕様通りに実装する必要がある。余裕があれば extract (URI から template を基に variables を取り出す) 操作もつくってみたい。

## 2016-06-02 Thu

『ソロモンの偽証』を観た。地上波にて 2 週連続で放送されていたものを 2 本一気に録画で観た。ネタバレする。

面白かった。なぜ柏木は死んだのかという謎に対して、手紙や校内裁判での証言を経て、真実に近づいていく。常に続きが気になるようできていて良かった。

「ソロモンの偽証」の題の意味は何だったのだろう。「偽証」はともかく、「ソロモン」は何なのか分からないので調べた。 [ソロモン - Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%BD%E3%83%AD%E3%83%A2%E3%83%B3) には次のようにある。

> ソロモンはエジプトのファラオ[1]の娘をめとり、ギブオンで盛大なささげものをした。そこで神がソロモンの夢枕に立ち、「何でも願うものを与えよう」というと、ソロモンは知恵を求めた。神はこれを喜び、多くのものを与えることを約束した。ここからソロモンは知恵者のシンボルとなり、ソロモンが子供のことで争う2人の女の一件で賢明な判断を示した逸話は広く世界に伝わり、後に江戸時代の大岡裁きの話にも取り込まれた[2]。

ソロモンは知恵者・賢明な判断をする者のような意味合いだろう。偽証は偽りの証言のことだろう。

ソロモンの偽証には、偽りの証言をした人物は相当な数が居るので、誰がソロモンという断定は難しい。ぼくなりに印象的だった人物を挙げる。

特に印象的なのは、おそらく大出俊次の弁護人を務めた神原和彦だろう。『後篇・裁判』の校内裁判を仕組んだ人物だし、柏木卓也が自殺したという真実をはじめから知っていた。最後に証人として裁判に参加する。映画の視聴者に対して真実を偽り続けた人物でもあると思う。

他に挙げるなら偽りの手紙を送って事件を大きくした三宅樹理だろう。賢いというよりずる賢しいという印象が強い。映画の視聴者に対しては大した偽りがなく、分かりやすい位置に居た。校内裁判において、保身のために目撃証言を友人の浅井松子の責任にした。浅井松子が嘘をついたのかは彼女以外には分からないはずだ。おそらく本人の様子を見れば明らか……ということなのだろう。

長い割に……というのはあるかもしれないけど、ぼくとしてはなかなか面白かった。

## 2016-06-01 Wed

[bouzuya/rfc6570-expand][] を [RFC 6570 URI Template](https://tools.ietf.org/html/rfc6570) level 4 に仮対応させた。実装の進捗や感想を書く。

[bouzuya/rfc6570-expand][] は [RFC 6570 URI Template](https://tools.ietf.org/html/rfc6570) を展開するための npm package 。RFC 6570 のことは [2016-05-28][] に書いた。そちらに覚書である Gist の URL や npm package を検証した repository URL も掲載している。

さて、冒頭で「仮」対応としたのは RFC 6570 に記載されている例の中でも簡単なものだけを test に追加して通すように直しただけだからだ。現状、厳密な意味では仕様に準拠していない。まだ実用段階にないので `npm publish` していない。

RFC 6570 は level 3 / level 4 あたりから複雑さが気になる。なぜ `:max-length` や `*` での Array / Object の特殊な展開が必要だと思ったのか。展開の規則も嫌に複雑というか、使う側も分かりづらい気がするのだけど……。このあたりの実装が現状は適当だ。

現状の実装について。環境は Node.js + TypeScript + Typings + eater + power-assert 。

Node.js は v6.1.0 にして ES2015 をほとんど使える前提で書いている。Transpile せず TypeScript で `"module": "commonjs"` かつ `"target": "es2015"` してある。普段は babel で transpile するか `"target": "es5"` するのだけど、面倒なのでこうしている。

testing には eater + power-assert を使っている。 [yosuke-furukawa/eater][] の検証は今回の主目的と言ってもいい。いまのところは良い印象を持っている。 AVA から乗り換えようと思っている。余計な機能がないし、Source Code をすべて読んでから使っていることもあって安心感がある。.d.ts が提供されていないことと reporter の弱さが気になる。 reporter はあとで自作したい。

今回の実装で面白いのは [uri-templates/uritemplate-test][] という RFC 6570 に記載されている例やその他の Test case が用意されていることだ。このおかげで仕様書をななめ読みして、あとは test 書いて通すだけの game と化している。ぼくは [4Clojure](http://www.4clojure.com/) を思い出した。いわゆる Koans だ。こういう仕組みはとてもいい。言語をまたいだ実装も安定する。

ちなみに、下記の Gist に書いた npm package のほとんどがこの test に通らない。

[RFC6570 - URI Template のための npm package に関する覚書](https://gist.github.com/bouzuya/b60bc84b6506d68ac75e6fe67f4d14fd)

主な原因は URL (URI) の定義である [RFC 2396](https://tools.ietf.org/html/rfc2396) / [RFC 3986](https://tools.ietf.org/html/rfc3986) / [URL Standard](https://url.spec.whatwg.org/) の非互換性だ。 RFC 6570 が参照しているのは RFC 3986 なので、準拠をうたうなら RFC 3986 に従う必要がある。一方で JavaScript の encodeURI や encodeURIComponent は RFC 3986 とは異なる挙動だ。おそらく RFC 2396 が基なのだろう。URL Standard についてはよく分からないが実際に動いているものを基準に定められているように思うので、RFC 2396 に近いものだと予想している。つまり RFC 6570 に準拠すると仕様上は正しいが一般的な URL からずれたものを使うことになる。

「地獄っぽい」という感想が浮かぶ。ひとまず RFC 3986 準拠、RFC 6570 準拠でつくり、 RFC 3986 と URL Standard の非互換性を補うための option で対応するつもりだ。

## 2016-05-31 Tue

今月をふりかえる。

過去のふりかえりは次のとおり。

- [2016-01-31][] 2016-01 ふりかえり
- [2016-02-29][] 2016-02 ふりかえり
- [2016-03-31][] 2016-03 ふりかえり
- [2016-05-01][] 2016-04 ふりかえり

単語でまとめると次のような感じ。

- 2016-W17 [2016-05-01][] ふりかえりのみ
- 2016-W18 [2016-05-08][] ぼくだけがいない街 /  [boajs/hackernews-boa][] / redux-thunk redux-saga
- 2016-W19 [2016-05-15][] kyoto.js #10 / redux-saga in TypeScript / [bouzuya/simple-gist-client][] / ミスミソウ / コマンドとイベント
- 2016-W20 [2016-05-22][] ClojureScript / 京都 Clojure の集い 16.05
- 2016-W21 [2016-05-29][] 進撃の巨人 前編 / combineReducers / 極黒のブリュンヒルデ / 入門 ClojureScript / RFC 6570 / SICP
- 2016-W22 ズートピア

主に redux / ClojureScript 。redux は仕事ですこし React / redux に触れたので、その関連もあって Twitter で言及している。ClojureScript は Kyoto.clj に合わせて 2 週間限定で試していた。ClojureScript 自体よりも Kyoto.clj をきっかけに SICP を読む決意を固めたのが大きい。あとは RFC 6570 に時間を割いている。

つくったもの。

- [bouzuya/rfc6570-expand][]
- [bouzuya/rfc6570-npm-packages][]
- [bouzuya/peggie2][]
- [bouzuya/ts-redux-saga-ssr][]
- [bouzuya/simple-gist-client][]
- [bouzuya/react-create-element][]
- [boajs/hackernews-boa][]

ろくなものをつくってない。

hackernews clone の b-o-a 実装である [boajs/hackernews-boa][] 。 gist の読み書きをする [simple-gist-client][] 。 RFC 6570 の展開をする [bouzuya/rfc6570-expand][] 。peggie は途中。rfc6570 もまだあと一歩。

目標。

- 「思ったことをすぐかたちのあるものにできる人」
- 「かたちにしたものを高く評価される人」

[bouzuya/rfc6570-expand][] は比較的はやく形にできている。評価されなさそうだけど。もっと役に立つものがほしい。[bouzuya/b-o-a][] は 12 star のまま。

数値目標。

- OK 毎日 [blog 記事](http://graph.hatena.ne.jp/bouzuya/bbn-entries-all/)を書く
- OK 52 個の[週次のふりかえりの記事](http://graph.hatena.ne.jp/bouzuya/bbn-entries-weekly-report/)を書く
- OK 12 個の[月次のふりかえりの記事](http://graph.hatena.ne.jp/bouzuya/bbn-entries-monthly-report/)を書く
- NG 50 個以上の [Qiita 記事](http://graph.hatena.ne.jp/bouzuya/qiita-items/)を書く
- OK 12 個以上の[よんだ記事](http://graph.hatena.ne.jp/bouzuya/bbn-entries-book/)を書く
- OK 26 個未満の[みた記事](http://graph.hatena.ne.jp/bouzuya/bbn-entries-movie/)を書く
- OK 24 個以上の勉強会にでた記事を書く (mockmock.dev を除く)
- NG 12 個以上の slide を公開する
- NG 毎日 6:00 に起きる
- OK blog の [weekly page views](http://graph.hatena.ne.jp/bouzuya/weekly-pageviews/)  が 700 を超える
- NG TOEIC で 550 を超える (CEFR B1 相当)
- OK 24 個の [GitHub リポジトリ](http://graph.hatena.ne.jp/bouzuya/GitHub%20Public%20Repos/) 395 → 419 をつくる
- NG 50 stars の GitHub public repository をつくる
勉強会。

blog の PV がすこし伸びて 700 を超えている。この調子で伸びて定常的に超えてくれるといいのだけど……。あとはよんだ記事が増えている。マンガはやめるはずなんだけど……。

勉強会。

- [2016-05-09][] Kyoto.js #10
- [2016-05-21][] 京都 Clojure の集い 16.05

京都ばかりだ。

良くない点。

- 録画した映画を観ていることが多い (書いていない) 。
- 英語の学習を投げている。
- Qiita の記事を書いていない。

総括。来月の目標。

先月は DDD 関連で読書一色。今月はものをつくる……はずが、そうでもなかった。ClojureScript に浮気してみたものの成果は残せず。来月は SICP を読み進める。また、 TODO がたまってきたので減らしたい。ああ、そういえば旅行の予定があったんだっけ……。うん、がんばろう。

## 2016-05-30 Mon

『ズートピア』を観た。2D 吹き替え版を映画館で妻と観た。

全体に対する印象は「すこしひねくれている」というもの。

これは『ズートピア』の伝えたいことが、現実における偏見・差別への言及にあるからだ。草食動物だから、キツネだから、などとと見た目で判断してはいけない。草食動物のウサギに警官は無理だと判断してはいけない。ウサギが小さいから弱いとは限らない。キツネがウソつきとは限らない。ヒツジがおとなしくて優しいとは限らない。ズートピアという街はすべての動物たちが共存するところとして描かれる。大きさ・形・考え方もいろいろな動物が共存している。でも同時に現実は偏見や差別を持った人も居るところとしても描かれる。

『ズートピア』は終始一貫して偏見・差別を裏切るようにできている。それがぼくにはすこしひねくれて見えたというわけ。
