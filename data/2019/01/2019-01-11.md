PureScript で何気なく↓を実行した。

`main = for_ (0 .. 10000) logShow`

↓は結果。

`RangeError: Maximum call stack size exceeded`

スタックオーバーフロー。

`for_` なんて名前だけどループのつもりで使うと死ぬ。そこで原因を調べていく。 `for_` は `traverse_` を `flip` したもの。

https://pursuit.purescript.org/packages/purescript-foldable-traversable/4.1.1/docs/Data.Foldable#v:for_

`traverse_` は `foldr` している。

`traverse_ f = foldr ((*>) <<< f) (pure unit)`

https://github.com/purescript/purescript-foldable-traversable/blob/v4.1.1/src/Data/Foldable.purs#L198

どうも `Effect` を大量にまとめているせいかな。

今回に限っての簡単な解決策は [purescript/purescript-effect][] の `foreachE` 。 `Effect Unit` で `Array` を……という話ならこれで良さそう。

`main = foreachE (0 .. 100000) logShow`

https://pursuit.purescript.org/packages/purescript-effect/2.0.0/docs/Effect#v:foreachE

`Effect` と同じパッケージに入っているのでまず間違いなく動く。

ほかには [paf31/purescript-safely][] の `for_` が良さそう。これなら見た目はまったく変わらない。

`main = for_ (0 .. 100000) logShow`

https://pursuit.purescript.org/packages/purescript-safely/4.0.0/docs/Control.Safely#v:for_

ただし package-sets の最新のタグ (psc-0.12.1-20190107) に safely パッケージは含まれていない。 psc-package を使う場合には注意。

https://github.com/purescript/package-sets/tree/psc-0.12.1-20190107

あとは safely でも利用している `MonadRec` クラスを直接使うのも手。つまり `tailRec` や `tailRecM` などを使う。

https://pursuit.purescript.org/packages/purescript-tailrec/4.0.0/docs/Control.Monad.Rec.Class#t:MonadRec
https://pursuit.purescript.org/packages/purescript-tailrec/4.0.0/docs/Control.Monad.Rec.Class#v:tailRec

おしまい。

https://twitter.com/bouzuya/status/1083004255651323904

[paf31/purescript-safely]: https://github.com/paf31/purescript-safely
[purescript/purescript-effect]: https://github.com/purescript/purescript-effect
